/*
日迹 DayTrace - 生命日历可视化 Obsidian 插件
*/

var k=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var q=(o,s)=>{for(var t in s)k(o,t,{get:s[t],enumerable:!0})},_=(o,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of H(s))!R.call(o,a)&&a!==t&&k(o,a,{get:()=>s[a],enumerable:!(e=j(s,a))||e.enumerable});return o};var G=o=>_(k({},"__esModule",{value:!0}),o);var U={};q(U,{default:()=>m});module.exports=G(U);var i=require("obsidian"),z={birthDate:"2000-01-01",lifeExpectancy:90,dailyNotesFolder:"",palette:{\u9ED8\u8BA4:"#D1D5DB",\u91CC\u7A0B\u7891:"#FF8A00",\u751F\u65E5:"#F59E0B",\u6210\u5C31:"#10B981",\u65C5\u884C:"#3B82F6",\u7EAA\u5FF5\u65E5:"#6366F1",\u5E86\u795D:"#EC4899"}},v="daytrace-view",m=class extends i.Plugin{async onload(){await this.loadSettings(),this.registerView(v,s=>new b(s,this)),this.addRibbonIcon("calendar-days","\u65E5\u8FF9 DayTrace",()=>{this.activateView()}),this.addCommand({id:"open-daytrace",name:"\u6253\u5F00\u65E5\u8FF9\u4EBA\u751F\u65E5\u5386",callback:()=>{this.activateView()}}),this.addSettingTab(new C(this.app,this))}onunload(){}async loadSettings(){this.settings=Object.assign({},z,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.app.workspace.getLeavesOfType(v).forEach(s=>{s.view instanceof b&&s.view.refresh()})}async activateView(){let{workspace:s}=this.app,t=null,e=s.getLeavesOfType(v);e.length>0?t=e[0]:(t=s.getRightLeaf(!1),await(t==null?void 0:t.setViewState({type:v,active:!0}))),t&&s.revealLeaf(t)}},b=class extends i.ItemView{constructor(t,e){super(t);this.dayDataMap=new Map;this.calendarWrapper=null;this.plugin=e}getViewType(){return v}getDisplayText(){return"\u65E5\u8FF9"}getIcon(){return"calendar-days"}async onOpen(){await this.loadDayData(),this.render(),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof i.TFile&&t.extension==="md"&&this.onFileChange(t)})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof i.TFile&&t.extension==="md"&&this.onFileChange(t)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof i.TFile&&t.extension==="md"&&this.loadDayData().then(()=>this.render(!0))}))}async onClose(){}async refresh(){await this.loadDayData(),this.render()}async onFileChange(t){let e=await this.parseDayData(t);e&&(this.dayDataMap.set(e.date,e),this.render(!0))}async parseDayData(t){let e=await this.app.vault.read(t),a=this.parseFrontMatter(e),n=a==null?void 0:a.date;if(!n){let S=t.basename.match(/^(\d{4}-\d{2}-\d{2})$/);S&&(n=S[1])}if(!n)return null;let r=a==null?void 0:a.lifeCalendar,d,h,u;return r&&(typeof r=="string"?(d=r,u=!0):typeof r=="object"&&(d=r.colorKey,h=r.color,u=r.special)),{date:n,file:t,color:h,colorKey:d,special:u}}parseFrontMatter(t){let e=t.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;try{return(0,i.parseYaml)(e[1])}catch(a){return null}}async loadDayData(){this.dayDataMap.clear();let t=this.app.vault.getMarkdownFiles(),e=this.plugin.settings.dailyNotesFolder;for(let a of t){if(e&&!a.path.startsWith(e))continue;let n=await this.parseDayData(a);n&&this.dayDataMap.set(n.date,n)}}render(t=!1){let e=t&&this.calendarWrapper?this.calendarWrapper.scrollTop:0,a=this.containerEl.children[1];a.empty(),a.addClass("daytrace-container");let n=this.plugin.settings,r=new Date(n.birthDate),d=new Date;d.setHours(0,0,0,0);let h=a.createDiv({cls:"daytrace-header"});h.createEl("h2",{text:"\u4EBA\u751F\u65E5\u5386"});let u=h.createDiv({cls:"daytrace-stats"}),S=n.lifeExpectancy*365,M=Math.floor((d.getTime()-r.getTime())/(1e3*60*60*24)),P=this.dayDataMap.size;u.createSpan({text:`${P} \u7BC7\u65E5\u8BB0`,cls:"stat-item"}),u.createSpan({text:`${n.lifeExpectancy} \u5E74`,cls:"stat-item"});let V=a.createDiv({cls:"daytrace-legend"});for(let[l,p]of Object.entries(n.palette)){let g=V.createDiv({cls:"legend-item"});g.createDiv({cls:"legend-color",attr:{style:`background-color: ${p}`}}),g.createSpan({text:l})}let L=a.createDiv({cls:"daytrace-nav"}),x=L.createEl("select",{cls:"age-select"});for(let l=0;l<=n.lifeExpectancy;l++){let p=x.createEl("option",{value:String(l),text:`${l} \u5C81`}),g=Math.floor(M/365);l===g&&(p.selected=!0)}x.addEventListener("change",()=>{let l=parseInt(x.value),p=a.querySelector(`[data-age="${l}"]`);p==null||p.scrollIntoView({behavior:"smooth",block:"start"})}),L.createEl("button",{text:"\u4ECA\u5929",cls:"today-btn"}).addEventListener("click",()=>{let l=a.querySelector(".day-cell.today");l==null||l.scrollIntoView({behavior:"smooth",block:"center"})}),this.calendarWrapper=a.createDiv({cls:"daytrace-calendar-wrapper"});let B=this.calendarWrapper.createDiv({cls:"daytrace-calendar"});for(let l=0;l<=n.lifeExpectancy;l++){let p=new Date(r);p.setFullYear(r.getFullYear()+l);let g=p.getFullYear(),E=B.createDiv({cls:"year-block",attr:{"data-age":String(l)}}),$=E.createDiv({cls:"year-header"});$.createSpan({text:`${g}`,cls:"year-label"}),$.createSpan({text:`${l} \u5C81`,cls:"age-label"});let I=E.createDiv({cls:"month-labels"}),W=["\u4E00\u6708","\u4E8C\u6708","\u4E09\u6708","\u56DB\u6708","\u4E94\u6708","\u516D\u6708","\u4E03\u6708","\u516B\u6708","\u4E5D\u6708","\u5341\u6708","\u5341\u4E00\u6708","\u5341\u4E8C\u6708"];for(let f of W)I.createSpan({text:f,cls:"month-label"});let A=E.createDiv({cls:"days-grid"}),N=new Date(g,0,1).getDay(),Y=N===0?6:N-1;for(let f=0;f<7;f++){let O=A.createDiv({cls:"week-row"});for(let F=0;F<53;F++){let K=F*7+f-Y,w=new Date(g,0,1+K),c=O.createDiv({cls:"day-cell"});if(w.getFullYear()!==g){c.addClass("empty");continue}if(w<r){c.addClass("before-birth");continue}if(w>d){c.addClass("future");continue}let D=this.formatDate(w);c.setAttribute("data-date",D),this.formatDate(d)===D&&c.addClass("today");let y=this.dayDataMap.get(D);if(y){c.addClass("has-note");let T=n.palette.\u9ED8\u8BA4;y.color?T=y.color:y.colorKey&&n.palette[y.colorKey]&&(T=n.palette[y.colorKey]),c.style.backgroundColor=T,y.special&&c.addClass("special")}else c.addClass("no-note");c.addEventListener("click",()=>{y?this.app.workspace.getLeaf().openFile(y.file):this.createDailyNote(D)}),c.setAttribute("aria-label",D)}}}t&&e>0&&this.calendarWrapper&&(this.calendarWrapper.scrollTop=e)}formatDate(t){let e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${n}`}async createDailyNote(t){let e=this.plugin.settings.dailyNotesFolder,a=`${t}.md`,n=e?`${e}/${a}`:a,r=this.app.vault.getAbstractFileByPath(n);if(r instanceof i.TFile){this.app.workspace.getLeaf().openFile(r);return}let d=`---
date: ${t}
---

# ${t}

`;try{e&&(this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e));let h=await this.app.vault.create(n,d);this.app.workspace.getLeaf().openFile(h),new i.Notice(`\u5DF2\u521B\u5EFA: ${a}`)}catch(h){new i.Notice(`\u521B\u5EFA\u5931\u8D25: ${h}`)}}},C=class extends i.PluginSettingTab{constructor(s,t){super(s,t),this.plugin=t}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"\u65E5\u8FF9 DayTrace \u8BBE\u7F6E"}),new i.Setting(s).setName("\u51FA\u751F\u65E5\u671F").setDesc("\u7528\u4E8E\u8BA1\u7B97\u5E74\u9F84\u548C\u751F\u6210\u65E5\u5386").addText(t=>t.setPlaceholder("YYYY-MM-DD").setValue(this.plugin.settings.birthDate).onChange(async e=>{/^\d{4}-\d{2}-\d{2}$/.test(e)&&(this.plugin.settings.birthDate=e,await this.plugin.saveSettings())})),new i.Setting(s).setName("\u9884\u671F\u5BFF\u547D").setDesc("\u65E5\u5386\u663E\u793A\u7684\u5E74\u6570").addSlider(t=>t.setLimits(50,120,1).setValue(this.plugin.settings.lifeExpectancy).setDynamicTooltip().onChange(async e=>{this.plugin.settings.lifeExpectancy=e,await this.plugin.saveSettings()})),new i.Setting(s).setName("\u6BCF\u65E5\u7B14\u8BB0\u6587\u4EF6\u5939").setDesc("\u7559\u7A7A\u5219\u626B\u63CF\u6574\u4E2A\u5E93").addText(t=>t.setPlaceholder("Daily Notes").setValue(this.plugin.settings.dailyNotesFolder).onChange(async e=>{this.plugin.settings.dailyNotesFolder=e,await this.plugin.saveSettings()})),s.createEl("h3",{text:"\u8C03\u8272\u677F"});for(let[t,e]of Object.entries(this.plugin.settings.palette))new i.Setting(s).setName(t).addColorPicker(a=>a.setValue(e).onChange(async n=>{this.plugin.settings.palette[t]=n,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("trash").setTooltip("\u5220\u9664").onClick(async()=>{if(t==="\u9ED8\u8BA4"){new i.Notice("\u65E0\u6CD5\u5220\u9664\u9ED8\u8BA4\u989C\u8272");return}delete this.plugin.settings.palette[t],await this.plugin.saveSettings(),this.display()}));new i.Setting(s).setName("\u6DFB\u52A0\u65B0\u989C\u8272").addText(t=>t.setPlaceholder("\u989C\u8272\u540D\u79F0").onChange(()=>{})).addColorPicker(t=>t.setValue("#3B82F6")).addButton(t=>t.setButtonText("\u6DFB\u52A0").onClick(async()=>{let e=s.querySelector(".setting-item:last-child input[type='text']"),a=s.querySelector(".setting-item:last-child input[type='color']");e&&a&&e.value&&(this.plugin.settings.palette[e.value]=a.value,await this.plugin.saveSettings(),this.display())}))}};
