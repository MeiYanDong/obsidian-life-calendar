/*
Life Calendar - 人生日历可视化 Obsidian 插件
*/

var I=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var J=(g,s)=>{for(var t in s)I(g,t,{get:s[t],enumerable:!0})},Q=(g,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of z(s))!U.call(g,a)&&a!==t&&I(g,a,{get:()=>s[a],enumerable:!(e=G(s,a))||e.enumerable});return g};var X=g=>Q(I({},"__esModule",{value:!0}),g);var tt={};J(tt,{default:()=>L});module.exports=X(tt);var i=require("obsidian"),Z={birthDate:"2000-01-01",lifeExpectancy:90,dailyNotesFolder:"",palette:{\u9ED8\u8BA4:"#D1D5DB",\u91CC\u7A0B\u7891:"#FF8A00",\u751F\u65E5:"#F59E0B",\u6210\u5C31:"#10B981",\u65C5\u884C:"#3B82F6",\u7EAA\u5FF5\u65E5:"#6366F1",\u5E86\u795D:"#EC4899"},intensityLevels:5,intensityOpacities:[.2,.4,.6,.8,1]},S="life-calendar-view",L=class extends i.Plugin{async onload(){await this.loadSettings(),this.registerView(S,s=>new E(s,this)),this.addRibbonIcon("calendar-days","Life Calendar",()=>{this.activateView()}),this.addCommand({id:"open-life-calendar",name:"\u6253\u5F00\u4EBA\u751F\u65E5\u5386",callback:()=>{this.activateView()}}),this.addSettingTab(new N(this.app,this))}onunload(){}async loadSettings(){var s;this.settings=Object.assign({},Z,await this.loadData()),this.settings.intensityLevels||(this.settings.intensityLevels=5),(s=this.settings.intensityOpacities)!=null&&s.length||(this.settings.intensityOpacities=[.2,.4,.6,.8,1])}async saveSettings(){await this.saveData(this.settings),this.app.workspace.getLeavesOfType(S).forEach(s=>{s.view instanceof E&&s.view.refresh()})}async activateView(){let{workspace:s}=this.app,t=null,e=s.getLeavesOfType(S);e.length>0?t=e[0]:(t=s.getRightLeaf(!1),await(t==null?void 0:t.setViewState({type:S,active:!0}))),t&&s.revealLeaf(t)}},E=class extends i.ItemView{constructor(t,e){super(t);this.dayDataMap=new Map;this.calendarWrapper=null;this.plugin=e}getViewType(){return S}getDisplayText(){return"Life Calendar"}getIcon(){return"calendar-days"}async onOpen(){await this.loadDayData(),this.render(),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof i.TFile&&t.extension==="md"&&this.onFileChange(t)})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof i.TFile&&t.extension==="md"&&this.onFileChange(t)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof i.TFile&&t.extension==="md"&&this.loadDayData().then(()=>this.render(!0))}))}async onClose(){}async refresh(){await this.loadDayData(),this.render()}async onFileChange(t){let e=await this.parseDayData(t);e&&(this.dayDataMap.set(e.date,e),this.render(!0))}async parseDayData(t){let e=await this.app.vault.read(t),a=this.parseFrontMatter(e),n=a==null?void 0:a.date;if(!n){let D=t.basename.match(/^(\d{4}-\d{2}-\d{2})$/);D&&(n=D[1])}if(!n)return null;let l=a==null?void 0:a.lifeCalendar,c,d,h,m;l&&(typeof l=="string"?(c=l,h=!0):typeof l=="object"&&(c=l.colorKey,d=l.color,h=l.special));let f=a==null?void 0:a.lifeCalendarIntensity;return typeof f=="number"&&(m=f),{date:n,file:t,color:d,colorKey:c,special:h,intensity:m}}parseFrontMatter(t){let e=t.match(/^---\n([\s\S]*?)\n---/);if(!e)return null;try{return(0,i.parseYaml)(e[1])}catch(a){return null}}blendColors(t,e,a){let n=t.replace("#",""),l=e.replace("#",""),c=parseInt(n.substring(0,2),16),d=parseInt(n.substring(2,4),16),h=parseInt(n.substring(4,6),16),m=parseInt(l.substring(0,2),16),f=parseInt(l.substring(2,4),16),D=parseInt(l.substring(4,6),16),F=Math.round(c+(m-c)*a),C=Math.round(d+(f-d)*a),v=Math.round(h+(D-h)*a);return`#${F.toString(16).padStart(2,"0")}${C.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`}async loadDayData(){this.dayDataMap.clear();let t=this.app.vault.getMarkdownFiles(),e=this.plugin.settings.dailyNotesFolder;for(let a of t){if(e&&!a.path.startsWith(e))continue;let n=await this.parseDayData(a);n&&this.dayDataMap.set(n.date,n)}}render(t=!1){var M;let e=t&&this.calendarWrapper?this.calendarWrapper.scrollTop:0,a=this.containerEl.children[1];a.empty(),a.addClass("daytrace-container");let n=this.plugin.settings,l=new Date(n.birthDate),c=new Date;c.setHours(0,0,0,0);let d=a.createDiv({cls:"daytrace-header"});d.createEl("h2",{text:"\u4EBA\u751F\u65E5\u5386"});let h=d.createDiv({cls:"daytrace-stats"}),m=n.lifeExpectancy*365,f=Math.floor((c.getTime()-l.getTime())/(1e3*60*60*24)),D=this.dayDataMap.size;h.createSpan({text:`${D} \u7BC7\u65E5\u8BB0`,cls:"stat-item"}),h.createSpan({text:`${n.lifeExpectancy} \u5E74`,cls:"stat-item"});let F=a.createDiv({cls:"daytrace-legend"});for(let[r,y]of Object.entries(n.palette)){let u=F.createDiv({cls:"legend-item"});u.createDiv({cls:"legend-color",attr:{style:`background-color: ${y}`}}),u.createSpan({text:r})}let C=a.createDiv({cls:"daytrace-nav"}),v=C.createEl("select",{cls:"age-select"});for(let r=0;r<=n.lifeExpectancy;r++){let y=v.createEl("option",{value:String(r),text:`${r} \u5C81`}),u=Math.floor(f/365);r===u&&(y.selected=!0)}v.addEventListener("change",()=>{let r=parseInt(v.value),y=a.querySelector(`[data-age="${r}"]`);y==null||y.scrollIntoView({behavior:"smooth",block:"start"})}),C.createEl("button",{text:"\u4ECA\u5929",cls:"today-btn"}).addEventListener("click",()=>{let r=a.querySelector(".day-cell.today");r==null||r.scrollIntoView({behavior:"smooth",block:"center"})}),this.calendarWrapper=a.createDiv({cls:"daytrace-calendar-wrapper"});let A=this.calendarWrapper.createDiv({cls:"daytrace-calendar"});for(let r=0;r<=n.lifeExpectancy;r++){let y=new Date(l);y.setFullYear(l.getFullYear()+r);let u=y.getFullYear(),T=A.createDiv({cls:"year-block",attr:{"data-age":String(r)}}),O=T.createDiv({cls:"year-header"});O.createSpan({text:`${u}`,cls:"year-label"}),O.createSpan({text:`${r} \u5C81`,cls:"age-label"});let B=T.createDiv({cls:"month-labels"}),W=["\u4E00\u6708","\u4E8C\u6708","\u4E09\u6708","\u56DB\u6708","\u4E94\u6708","\u516D\u6708","\u4E03\u6708","\u516B\u6708","\u4E5D\u6708","\u5341\u6708","\u5341\u4E00\u6708","\u5341\u4E8C\u6708"];for(let w of W)B.createSpan({text:w,cls:"month-label"});let Y=T.createDiv({cls:"days-grid"}),V=new Date(u,0,1).getDay(),K=V===0?6:V-1;for(let w=0;w<7;w++){let j=Y.createDiv({cls:"week-row"});for(let k=0;k<53;k++){let H=k*7+w-K,x=new Date(u,0,1+H),p=j.createDiv({cls:"day-cell"});if(x.getFullYear()!==u){p.addClass("empty");continue}if(x<l){p.addClass("before-birth");continue}if(x>c){p.addClass("future");continue}let b=this.formatDate(x);p.setAttribute("data-date",b),this.formatDate(c)===b&&p.addClass("today");let o=this.dayDataMap.get(b);if(o){p.addClass("has-note");let $=n.palette.\u9ED8\u8BA4;o.color?$=o.color:o.colorKey&&n.palette[o.colorKey]&&($=n.palette[o.colorKey]);let P=1;if(o.intensity!==void 0){let q=Math.max(1,Math.min(o.intensity,n.intensityLevels));P=(M=n.intensityOpacities[q-1])!=null?M:1}let R=n.palette.\u9ED8\u8BA4,_=this.blendColors(R,$,P);p.style.backgroundColor=_,(o.colorKey||o.color||o.special)&&p.addClass("special")}else p.addClass("no-note");p.addEventListener("click",()=>{o?this.app.workspace.getLeaf().openFile(o.file):this.createDailyNote(b)}),p.setAttribute("aria-label",b)}}}t&&e>0&&this.calendarWrapper&&(this.calendarWrapper.scrollTop=e)}formatDate(t){let e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${n}`}async createDailyNote(t){let e=this.plugin.settings.dailyNotesFolder,a=`${t}.md`,n=e?`${e}/${a}`:a,l=this.app.vault.getAbstractFileByPath(n);if(l instanceof i.TFile){this.app.workspace.getLeaf().openFile(l);return}let c=`---
date: ${t}
---

# ${t}

`;try{e&&(this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e));let d=await this.app.vault.create(n,c);this.app.workspace.getLeaf().openFile(d),new i.Notice(`\u5DF2\u521B\u5EFA: ${a}`)}catch(d){new i.Notice(`\u521B\u5EFA\u5931\u8D25: ${d}`)}}},N=class extends i.PluginSettingTab{constructor(s,t){super(s,t),this.plugin=t}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"Life Calendar \u8BBE\u7F6E"}),new i.Setting(s).setName("\u51FA\u751F\u65E5\u671F").setDesc("\u7528\u4E8E\u8BA1\u7B97\u5E74\u9F84\u548C\u751F\u6210\u65E5\u5386").addText(t=>t.setPlaceholder("YYYY-MM-DD").setValue(this.plugin.settings.birthDate).onChange(async e=>{/^\d{4}-\d{2}-\d{2}$/.test(e)&&(this.plugin.settings.birthDate=e,await this.plugin.saveSettings())})),new i.Setting(s).setName("\u9884\u671F\u5BFF\u547D").setDesc("\u65E5\u5386\u663E\u793A\u7684\u5E74\u6570").addSlider(t=>t.setLimits(50,120,1).setValue(this.plugin.settings.lifeExpectancy).setDynamicTooltip().onChange(async e=>{this.plugin.settings.lifeExpectancy=e,await this.plugin.saveSettings()})),new i.Setting(s).setName("\u6BCF\u65E5\u7B14\u8BB0\u6587\u4EF6\u5939").setDesc("\u7559\u7A7A\u5219\u626B\u63CF\u6574\u4E2A\u5E93").addText(t=>t.setPlaceholder("Daily Notes").setValue(this.plugin.settings.dailyNotesFolder).onChange(async e=>{this.plugin.settings.dailyNotesFolder=e,await this.plugin.saveSettings()})),s.createEl("h3",{text:"\u8C03\u8272\u677F"});for(let[t,e]of Object.entries(this.plugin.settings.palette))new i.Setting(s).setName(t).addColorPicker(a=>a.setValue(e).onChange(async n=>{this.plugin.settings.palette[t]=n,await this.plugin.saveSettings()})).addExtraButton(a=>a.setIcon("trash").setTooltip("\u5220\u9664").onClick(async()=>{if(t==="\u9ED8\u8BA4"){new i.Notice("\u65E0\u6CD5\u5220\u9664\u9ED8\u8BA4\u989C\u8272");return}delete this.plugin.settings.palette[t],await this.plugin.saveSettings(),this.display()}));new i.Setting(s).setName("\u6DFB\u52A0\u65B0\u989C\u8272").addText(t=>t.setPlaceholder("\u989C\u8272\u540D\u79F0").onChange(()=>{})).addColorPicker(t=>t.setValue("#3B82F6")).addButton(t=>t.setButtonText("\u6DFB\u52A0").onClick(async()=>{let e=s.querySelector(".setting-item:last-child input[type='text']"),a=s.querySelector(".setting-item:last-child input[type='color']");e&&a&&e.value&&(this.plugin.settings.palette[e.value]=a.value,await this.plugin.saveSettings(),this.display())})),s.createEl("h3",{text:"\u7CBE\u5F69\u7A0B\u5EA6"}),new i.Setting(s).setName("\u7A0B\u5EA6\u68AF\u5EA6\u6570\u91CF").setDesc("\u7CBE\u5F69\u7A0B\u5EA6\u7684\u7EA7\u522B\u6570\u91CF\uFF08\u9ED8\u8BA4 5\uFF09").addSlider(t=>t.setLimits(2,10,1).setValue(this.plugin.settings.intensityLevels).setDynamicTooltip().onChange(async e=>{this.plugin.settings.intensityLevels=e,this.plugin.settings.intensityOpacities=Array.from({length:e},(a,n)=>(n+1)/e),await this.plugin.saveSettings(),this.display()}));for(let t=1;t<=this.plugin.settings.intensityLevels;t++)new i.Setting(s).setName(`\u7EA7\u522B ${t}`).setDesc(`\u7CBE\u5F69\u7A0B\u5EA6 ${t} \u7684\u4E0D\u900F\u660E\u5EA6`).addSlider(e=>{var a;return e.setLimits(0,100,5).setValue(((a=this.plugin.settings.intensityOpacities[t-1])!=null?a:t/this.plugin.settings.intensityLevels)*100).setDynamicTooltip().onChange(async n=>{this.plugin.settings.intensityOpacities[t-1]=n/100,await this.plugin.saveSettings()})})}};
